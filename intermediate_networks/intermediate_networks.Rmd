---
title: "Tutorial"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(learnr)
knitr::opts_chunk$set(echo = FALSE)


library(gradethis)
library(igraph)
library(tidyverse)

tutorial_options(exercise.checker = gradethis::grade_learnr)

mail_edgelist = read_csv("enron_edgelist.csv")
mail <- graph_from_data_frame(mail_edgelist)

```


### Components
Components, subgraphs or clusters (they are ususally all the same thing) are groups of the network where all nodes can reach all other nodes. In directed networks, we differentiate between strongly and weakly connected components. 

In any network, there are two types of components:  regular components, strongly connected components and weakly connected components.  These fully connected components can be divided into . Strongly connected components  by traversing the network in the direction of the edge. Weak components are parts of the network where every node can reach every other node, but need to ignore the directionality in order to get there. Some components can be fully connected - meaning that every node can reach every other node in the component directly - there is an edge between them. Here too, we can distinguish between strongly and weakly fully connected components.

When interpreting our network, components can suggest we have groups of friends, good colleagues, or project teams. Some networks consist of several weakly connected components, meaning that there are parts of the networks (in our example that would be parts of the company) that are isolated from each other. We can find components simply by using the `components` function - the challing part is using the output.

```{r strong_component}

strong_components <- components(mail, mode="strong")

```

The `strong_components` object is a list consisting of:

- `membership`: the component number that each of the nodes belong to. This is a vector of numbers with the same lenght, and order, as `V(enron2)`.
- `csize`: the size of each of the clusters. This is a vector of numbers of length equal to the number of clusters.
- `no`: the number of components. This is a single number.

The membership list can be used to calculate the sizes and the number of clusters, but it is convenient that we get those for free. Now that we have the components list, 

Using the concept of components, we can answer the last of the questions posed when we first started looking at the Enron data: Are there tightly connected groups of nodes, and how large are they?

Lets start by finding the size of the largest component. Since the component sizes are laid out in a separate vector, this is easy to find.

```{r biggest_strong_component, exercise=TRUE}

max(strong_components$csize)

```

The largest strong component comprizes almost 8000 nodes, around `r round(100*max(strong_components$csize)/sum(strong_components$csize))`per cent of the nodes. This is a significant percentage, but not particularly high compared to other networks.

Now it's your turn, try to find the number of nodes that are part of the largest weak component:

```{r weak_component, exercise=TRUE}

weak_components <- ____

____

```


```{r weak_component-solution}

weak_components <- components(mail, mode="weak")

max(weak_components$csize)

```



Using the `weak_components` object you created above, find the size of the biggest weak component as share of the network:

```{r create_weak_component, include=FALSE}

weak_components <- components(mail, mode="weak")

```


```{r weak_component_share, exercise=TRUE}

____ / ____

```

```{r weak_component_share-solution}

max(weak_components$csize) / sum(weak_components$csize)
# OR
max(weak_components$csize) / length(V(mail))
# OR
max(weak_components$csize) / length(weak_components$membership)

```

Nearly 90 % of the network is part of the largest weak component. Remember that weak components are clusters of nodes that share no edges at all with the other nodes in the network. They are completely isolated little islands and could be an entirely separate network.

The second-largest weak component consists only of 21 nodes - a steep drop from more than 32 000. Let's try to isolate those nodes and plot them. In order to do this, we will need to use some new functions and properties of the graph.

```{r plot_component, fig.width=9, exercise=TRUE}

# component is of size 21 (TRUE/FALSE vector)
c21 <- weak_components$csize==21

component_number <- which(c21)
member_nodes <- weak_components$membership==component_number

e_subset <- subgraph(mail, member_nodes)
  
plot(e_subset, vertex.size=35)

```

All the components are identified by a number - simply an index ranging from 1 to however many components there are. Nodes are identified in a similar way: by their index in the vector. Both `weak_components$csize` and `weak_components$membership` use this ordering. The vector of component sizes uses the index to denote the cluster number. The membership vector has the same length and same order as the nodes in the network (`E(enron2)`). The values of the membership vector is the component that the node is a member of.

This might all seem a little complex, but we did what we needed to do in very few lines of code. First, we find components of size 21 (there is only one). This returns an ordered vector of `TRUE`/`FALSE`, We want to know the index number of the element that is `TRUE`, because that index number is the ID of the component and can be found in the membership vector. The `which` function does excatly that, and leaves us in this case with a single number which we store in `component_number`. Next, we need to find the nodes that are part of that cluster number. We do that simply by filtering the members vector for the value we saved to `component_number`. This again results in a vector of TRUE/FALSE values, that we can use to subset the graph with the `subset` function which takes the graph as the first object, and a vector of the nodes to keep (a TRUE/FALSE vector with length equal to the number of nodes).

All this results in a new, small network that we can plot.

Now it's your turn to try this, with the strong components. First, find the size of the second largest component:

```{r strong_components_subset, exercise=TRUE}

strong_components <- components(mail, mode="strong")

____

```

```{r strong_components_subset-solution}

strong_components <- components(mail, mode="strong")

tail(sort(strong_components$csize))

```

We see the size of the second largest component is 6. Now, let's try to identify the nodes of that cluster, and plot them.

```{r strong_components_plot, exercise=TRUE}

component_size_6 <- ____ 

component_number <- ____
member_nodes <- ____

e_subset <- ____(____, ____)
  
plot(e_subset, ____)

```

```{r strong_components_plot-solution}

component_size_6 <- strong_components$csize == 6 

component_number <- which(component_size_6)
member_nodes <- strong_components$membership == component_number

e_subset <- subgraph(mail, member_nodes)

plot(e_subset, vertex.size=35)

```